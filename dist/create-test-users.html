<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Test Users - SPF Tongod</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Create Test Users for SPF Tongod</h5>
                    </div>
                    <div class="card-body">
                        <div id="alertContainer"></div>
                        
                        <p class="text-muted">This tool creates test user accounts for development and testing purposes.</p>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-primary w-100" onclick="createTestUser('admin')">
                                    <i class="fas fa-user-shield me-2"></i>
                                    Create Admin User
                                </button>
                                <small class="text-muted d-block mt-1">
                                    admin@spftongod.my<br>
                                    Password: admin123
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-success w-100" onclick="createTestUser('staff')">
                                    <i class="fas fa-user-tie me-2"></i>
                                    Create Staff User
                                </button>
                                <small class="text-muted d-block mt-1">
                                    staff@spftongod.my<br>
                                    Password: staff123
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-info w-100" onclick="createTestUser('assistant')">
                                    <i class="fas fa-user me-2"></i>
                                    Create Assistant User
                                </button>
                                <small class="text-muted d-block mt-1">
                                    assistant@spftongod.my<br>
                                    Password: assistant123
                                </small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-warning w-100" onclick="createTestUser('viewer')">
                                    <i class="fas fa-eye me-2"></i>
                                    Create Viewer User
                                </button>
                                <small class="text-muted d-block mt-1">
                                    viewer@spftongod.my<br>
                                    Password: viewer123
                                </small>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="text-center">
                            <button class="btn btn-danger" onclick="createAllTestUsers()">
                                <i class="fas fa-users me-2"></i>
                                Create All Test Users
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <a href="index.html" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth, db } from './js/firebase-config.js';
        import { 
            createUserWithEmailAndPassword,
            updateProfile,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            doc, 
            setDoc, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const testUsers = {
            admin: {
                email: 'admin@spftongod.my',
                password: 'admin123',
                name: 'Administrator System',
                role: 'admin',
                department: 'ICT',
                position: 'Pentadbir Sistem'
            },
            staff: {
                email: 'staff@spftongod.my',
                password: 'staff123',
                name: 'Pegawai Jabatan',
                role: 'staff_jabatan',
                department: 'Pentadbiran',
                position: 'Pegawai Tadbir'
            },
            assistant: {
                email: 'assistant@spftongod.my',
                password: 'assistant123',
                name: 'Pembantu Tadbir',
                role: 'staff_pembantu',
                department: 'Pentadbiran',
                position: 'Pembantu Tadbir'
            },
            viewer: {
                email: 'viewer@spftongod.my',
                password: 'viewer123',
                name: 'Pengguna Lihat',
                role: 'user_view',
                department: 'Pentadbiran',
                position: 'Pegawai'
            }
        };

        window.createTestUser = async function(userType) {
            const user = testUsers[userType];
            if (!user) return;

            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

            try {
                // Create user account
                const userCredential = await createUserWithEmailAndPassword(auth, user.email, user.password);
                const firebaseUser = userCredential.user;

                // Update display name
                await updateProfile(firebaseUser, {
                    displayName: user.name
                });

                // Create user profile in Firestore
                const userProfile = {
                    name: user.name,
                    email: user.email,
                    role: user.role,
                    department: user.department,
                    position: user.position,
                    phone: '',
                    is_active: true,
                    email_verified: true, // Test users are auto-verified
                    created_at: serverTimestamp(),
                    updated_at: serverTimestamp(),
                    created_by: 'test-script'
                };

                await setDoc(doc(db, 'users', firebaseUser.uid), userProfile);

                // Sign out the test user
                await signOut(auth);

                showAlert(`Test user ${user.name} created successfully!`, 'success');
            } catch (error) {
                console.error('Error creating test user:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    showAlert(`User ${user.email} already exists`, 'warning');
                } else {
                    showAlert(`Error creating user: ${error.message}`, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        };

        window.createAllTestUsers = async function() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating All Users...';

            try {
                for (const [userType, user] of Object.entries(testUsers)) {
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, user.email, user.password);
                        const firebaseUser = userCredential.user;

                        await updateProfile(firebaseUser, {
                            displayName: user.name
                        });

                        const userProfile = {
                            name: user.name,
                            email: user.email,
                            role: user.role,
                            department: user.department,
                            position: user.position,
                            phone: '',
                            is_active: true,
                            email_verified: true,
                            created_at: serverTimestamp(),
                            updated_at: serverTimestamp(),
                            created_by: 'test-script'
                        };

                        await setDoc(doc(db, 'users', firebaseUser.uid), userProfile);
                        await signOut(auth);

                        console.log(`Created test user: ${user.name}`);
                    } catch (error) {
                        if (error.code !== 'auth/email-already-in-use') {
                            console.error(`Error creating ${userType}:`, error);
                        }
                    }
                }

                showAlert('All test users created successfully!', 'success');
            } catch (error) {
                showAlert(`Error creating users: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        };

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const icon = type === 'error' ? 'fa-exclamation-circle' :
                        type === 'success' ? 'fa-check-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    </script>
</body>
</html>