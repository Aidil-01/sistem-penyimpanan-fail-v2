<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Test Location Dropdown v2 - Firebase Debug</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .test-container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
        }
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .log-container {
            background: #212529;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 15px 0;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        
        .dropdown-test {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .dropdown-test.loading {
            border-color: #17a2b8;
            background-color: #f0f8ff;
        }
        
        .dropdown-test.success {
            border-color: #28a745;
            background-color: #f0fff0;
        }
        
        .dropdown-test.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        
        select.loading {
            border-color: #17a2b8;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }
        
        select.success {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        select.error {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .test-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        
        .test-card h6 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container test-container">
        <div class="text-center mb-4">
            <h2><i class="fas fa-bug me-2"></i>Test Location Dropdown v2</h2>
            <p class="text-muted">Comprehensive testing untuk Firebase lokasi collection debugging</p>
            <div class="badge bg-info">Debug Mode: <span id="debugStatus">Loading...</span></div>
        </div>

        <!-- Quick Status Overview -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-tachometer-alt me-2"></i>Quick Status</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="h4 mb-1">
                            <span class="status-indicator" id="firebaseStatus"></span>
                            <span id="firebaseText">Checking...</span>
                        </div>
                        <small class="text-muted">Firebase Connection</small>
                    </div>
                    <div class="col-md-3">
                        <div class="h4 mb-1">
                            <span class="status-indicator" id="collectionStatus"></span>
                            <span id="collectionText">Checking...</span>
                        </div>
                        <small class="text-muted">Lokasi Collection</small>
                    </div>
                    <div class="col-md-3">
                        <div class="h4 mb-1">
                            <span class="status-indicator" id="dataStatus"></span>
                            <span id="dataText">0</span>
                        </div>
                        <small class="text-muted">Documents Found</small>
                    </div>
                    <div class="col-md-3">
                        <div class="h4 mb-1">
                            <span class="status-indicator" id="dropdownStatus"></span>
                            <span id="dropdownText">0</span>
                        </div>
                        <small class="text-muted">Dropdown Options</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase Debug Panel -->
        <div class="debug-panel">
            <h5><i class="fas fa-database me-2"></i>Firebase Diagnostic</h5>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary me-2" onclick="runFirebaseDebug()">
                        <i class="fas fa-play"></i> Run Firebase Debug
                    </button>
                    <button class="btn btn-info me-2" onclick="testCollectionAccess()">
                        <i class="fas fa-search"></i> Test Collection Access
                    </button>
                    <button class="btn btn-warning" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Clear Logs
                    </button>
                </div>
                <div class="col-md-6">
                    <div id="firebaseDebugSummary" class="text-end">
                        <small class="text-muted">Click "Run Firebase Debug" to start</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Dropdown Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-list me-2"></i>Location Dropdown Tests</h5>
            </div>
            <div class="card-body">
                
                <!-- Test 1: Basic Dropdown -->
                <div class="dropdown-test" id="test1">
                    <h6><i class="fas fa-flask me-2"></i>Test 1: Basic Location Dropdown</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Pilih Lokasi</label>
                            <select class="form-select" id="locationDropdown1">
                                <option>⏳ Initializing...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <div id="test1Status" class="form-control-plaintext">
                                <span class="badge bg-secondary">Pending</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="runTest1()">
                        <i class="fas fa-play"></i> Run Test 1
                    </button>
                </div>

                <!-- Test 2: Enhanced Dropdown with Debug -->
                <div class="dropdown-test" id="test2">
                    <h6><i class="fas fa-bug me-2"></i>Test 2: Enhanced Dropdown (Debug Mode)</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Pilih Lokasi (Enhanced)</label>
                            <select class="form-select" id="locationDropdown2">
                                <option>⏳ Initializing...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Real-time Updates</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="realtimeUpdates" checked>
                                <label class="form-check-label" for="realtimeUpdates">
                                    Enable Real-time Listener
                                </label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-success mt-2" onclick="runTest2()">
                        <i class="fas fa-play"></i> Run Test 2
                    </button>
                </div>

                <!-- Test 3: Fallback Test -->
                <div class="dropdown-test" id="test3">
                    <h6><i class="fas fa-shield-alt me-2"></i>Test 3: Fallback Mechanism</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Lokasi (Fallback Mode)</label>
                            <select class="form-select" id="locationDropdown3">
                                <option>⏳ Initializing...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="code-block">
                                Force fallback mode:<br>
                                <code>manager.activeCollection = null;</code>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-warning mt-2" onclick="runTest3()">
                        <i class="fas fa-play"></i> Run Test 3 (Force Fallback)
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Results Grid -->
        <div class="test-results" id="testResults">
            <!-- Results will be populated dynamically -->
        </div>

        <!-- Debug Logs -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-terminal me-2"></i>Debug Logs</h5>
                <div>
                    <button class="btn btn-sm btn-outline-info" onclick="exportLogs()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="debugLogs" class="log-container">
                    <div class="text-muted">Debug logs will appear here...</div>
                </div>
            </div>
        </div>

        <!-- Manual Debug Tools -->
        <div class="debug-panel">
            <h5><i class="fas fa-tools me-2"></i>Manual Debug Tools</h5>
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="window.debugLocationDropdown?.()">
                        Check Manager Status
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-info btn-sm w-100 mb-2" onclick="inspectFirebaseData()">
                        Inspect Firebase Data
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="validateDropdownData()">
                        Validate Dropdown Data
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase and Debug Scripts -->
    <script type="module">
        import FirebaseDataDebugger from './js/debug-firebase-data.js?debug=true';
        import locationDropdownManager from './js/location-dropdown-fix-v2.js';

        let debugger;
        let logs = [];

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            log('🚀 Test page loaded, initializing...');
            
            // Set debug status
            document.getElementById('debugStatus').textContent = 'Active';
            
            // Initialize debugger
            debugger = new FirebaseDataDebugger();
            window.firebaseDebugger = debugger;
            
            // Auto-run basic tests
            setTimeout(async () => {
                await refreshStatus();
                log('✅ Initialization complete');
            }, 1000);
        });

        // Logging function
        window.log = function(message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = { timestamp, message, data };
            logs.push(logEntry);
            
            const logContainer = document.getElementById('debugLogs');
            const logElement = document.createElement('div');
            logElement.innerHTML = `<span style="color: #6c757d;">[${timestamp.substr(11, 8)}]</span> ${message}`;
            
            if (data) {
                logElement.innerHTML += `<br><span style="color: #28a745; padding-left: 20px;">${JSON.stringify(data, null, 2)}</span>`;
            }
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        };

        // Status refresh function
        window.refreshStatus = async function() {
            log('🔄 Refreshing status...');
            
            try {
                // Test Firebase connection
                const connectionTest = await debugger.testFirebaseConnection();
                updateStatusIndicator('firebaseStatus', 'firebaseText', connectionTest, connectionTest ? 'Connected' : 'Failed');
                
                // Test collection access
                const collectionTest = await debugger.debugLokasiCollection();
                const hasCollection = collectionTest && collectionTest.snapshot.size > 0;
                updateStatusIndicator('collectionStatus', 'collectionText', hasCollection, hasCollection ? collectionTest.collectionName : 'Not Found');
                
                // Get dropdown manager status
                const managerStatus = locationDropdownManager.getStatus();
                document.getElementById('dataText').textContent = managerStatus.locationCount;
                document.getElementById('dropdownText').textContent = managerStatus.availableSlotCount;
                
                updateStatusIndicator('dataStatus', null, managerStatus.locationCount > 0);
                updateStatusIndicator('dropdownStatus', null, managerStatus.availableSlotCount > 0);
                
                log(`✅ Status updated - Collection: ${hasCollection ? 'Found' : 'Not Found'}, Data: ${managerStatus.locationCount} locations`);
                
            } catch (error) {
                log('❌ Error refreshing status:', error);
            }
        };

        // Update status indicator
        function updateStatusIndicator(indicatorId, textId, success, text = null) {
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.className = `status-indicator ${success ? 'status-success' : 'status-error'}`;
            }
            
            if (textId && text !== null) {
                const textElement = document.getElementById(textId);
                if (textElement) {
                    textElement.textContent = text;
                }
            }
        }

        // Firebase debug function
        window.runFirebaseDebug = async function() {
            log('🔍 Running comprehensive Firebase diagnostic...');
            
            try {
                const results = await debugger.runComprehensiveDiagnostic();
                const report = debugger.generateReport(results);
                
                log('📋 Firebase diagnostic completed:', report.summary);
                
                // Update summary display
                const summaryElement = document.getElementById('firebaseDebugSummary');
                summaryElement.innerHTML = `
                    <div class="text-start">
                        <strong>Firebase Diagnostic Results:</strong><br>
                        <small>
                            Connection: ${report.summary.firebaseConnection ? '✅' : '❌'} | 
                            Collection: ${report.summary.collectionName} | 
                            Documents: ${report.summary.documentsFound} | 
                            Permissions: ${report.summary.permissionsOK ? '✅' : '❌'}
                        </small>
                    </div>
                `;
                
                window.lastFirebaseReport = report;
                
            } catch (error) {
                log('❌ Firebase diagnostic failed:', error);
            }
        };

        // Test collection access
        window.testCollectionAccess = async function() {
            log('🔍 Testing collection access...');
            
            const collections = ['lokasi', 'locations', 'Lokasi'];
            for (const collectionName of collections) {
                try {
                    const result = await debugger.debugPermissions(collectionName);
                    log(`📂 Collection '${collectionName}':`, result);
                } catch (error) {
                    log(`❌ Error testing '${collectionName}':`, error);
                }
            }
        };

        // Test functions
        window.runTest1 = async function() {
            log('🧪 Running Test 1: Basic Location Dropdown');
            
            const dropdown = document.getElementById('locationDropdown1');
            const testDiv = document.getElementById('test1');
            const statusDiv = document.getElementById('test1Status');
            
            testDiv.className = 'dropdown-test loading';
            statusDiv.innerHTML = '<span class="badge bg-info">Running...</span>';
            
            try {
                const success = await locationDropdownManager.populateLocationDropdown(dropdown);
                
                if (success) {
                    testDiv.className = 'dropdown-test success';
                    statusDiv.innerHTML = '<span class="badge bg-success">Success</span>';
                    log('✅ Test 1 completed successfully');
                } else {
                    testDiv.className = 'dropdown-test error';
                    statusDiv.innerHTML = '<span class="badge bg-warning">Partial Success (Fallback)</span>';
                    log('⚠️ Test 1 completed with fallback data');
                }
                
            } catch (error) {
                testDiv.className = 'dropdown-test error';
                statusDiv.innerHTML = '<span class="badge bg-danger">Failed</span>';
                log('❌ Test 1 failed:', error);
            }
        };

        window.runTest2 = async function() {
            log('🧪 Running Test 2: Enhanced Dropdown with Real-time');
            
            const dropdown = document.getElementById('locationDropdown2');
            const testDiv = document.getElementById('test2');
            const realtimeEnabled = document.getElementById('realtimeUpdates').checked;
            
            testDiv.className = 'dropdown-test loading';
            
            try {
                const success = await locationDropdownManager.populateLocationDropdown(dropdown);
                
                if (success && realtimeEnabled) {
                    const listener = locationDropdownManager.setupRealtimeListener(dropdown);
                    log('🔄 Real-time listener set up:', listener ? 'Success' : 'Failed');
                }
                
                testDiv.className = 'dropdown-test success';
                log('✅ Test 2 completed successfully');
                
            } catch (error) {
                testDiv.className = 'dropdown-test error';
                log('❌ Test 2 failed:', error);
            }
        };

        window.runTest3 = async function() {
            log('🧪 Running Test 3: Fallback Mechanism');
            
            const dropdown = document.getElementById('locationDropdown3');
            const testDiv = document.getElementById('test3');
            
            testDiv.className = 'dropdown-test loading';
            
            try {
                // Force fallback mode
                const originalCollection = locationDropdownManager.activeCollection;
                locationDropdownManager.activeCollection = null;
                
                const success = await locationDropdownManager.populateLocationDropdown(dropdown);
                
                // Restore original collection
                locationDropdownManager.activeCollection = originalCollection;
                
                testDiv.className = 'dropdown-test success';
                log('✅ Test 3 completed - fallback mechanism working');
                
            } catch (error) {
                testDiv.className = 'dropdown-test error';
                log('❌ Test 3 failed:', error);
            }
        };

        // Utility functions
        window.clearLogs = function() {
            document.getElementById('debugLogs').innerHTML = '<div class="text-muted">Debug logs cleared...</div>';
            logs = [];
        };

        window.exportLogs = function() {
            const logData = {
                timestamp: new Date().toISOString(),
                logs: logs,
                status: locationDropdownManager.getStatus(),
                validation: locationDropdownManager.validateData()
            };
            
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `location-dropdown-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('📄 Debug logs exported');
        };

        window.inspectFirebaseData = function() {
            if (window.firebaseDebugger) {
                window.firebaseDebugger.runComprehensiveDiagnostic().then(results => {
                    console.log('🔍 Firebase Data Inspection:', results);
                    log('🔍 Firebase data inspection completed - check console');
                });
            } else {
                log('❌ Firebase debugger not available');
            }
        };

        window.validateDropdownData = function() {
            const validation = locationDropdownManager.validateData();
            log('📊 Dropdown data validation:', validation);
        };

    </script>
</body>
</html>